<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤ - 5184 Saard</title>
    <script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e77b3 0%, #bedff0 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 30px rgba(30, 119, 179, 0.15);
        }
        .btn-primary {
            background: linear-gradient(135deg, #1e77b3 0%, #2c91d1 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(30, 119, 179, 0.3);
        }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-white mb-2">‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤</h1>
            <p class="text-white opacity-90">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</p>
        </div>

        <!-- Main Form -->
        <div class="bg-white rounded-2xl p-6 card-shadow max-w-md mx-auto">
            <form id="complaintForm" class="space-y-4">
                <!-- User Info (Auto-filled from LIFF) -->
                <div id="userInfo" class="p-3 bg-blue-50 rounded-lg mb-4">
                    <p class="text-sm text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...</p>
                </div>

                <!-- Problem Type -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏†‡∏≤‡∏û‡∏õ‡∏±‡∏ç‡∏´‡∏≤ *</label>
                    <select id="problemType" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏†‡∏≤‡∏û‡∏õ‡∏±‡∏ç‡∏´‡∏≤</option>
                        <option value="‡∏ó‡πà‡∏≠‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤‡πÅ‡∏ï‡∏Å">‡∏ó‡πà‡∏≠‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤‡πÅ‡∏ï‡∏Å</option>
                        <option value="‡∏ô‡πâ‡∏≥‡∏Ç‡∏∏‡πà‡∏ô">‡∏ô‡πâ‡∏≥‡∏Ç‡∏∏‡πà‡∏ô</option>
                        <option value="‡∏ô‡πâ‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏•">‡∏ô‡πâ‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏•</option>
                        <option value="‡∏ô‡πâ‡∏≥‡∏°‡∏µ‡∏Å‡∏•‡∏¥‡πà‡∏ô">‡∏ô‡πâ‡∏≥‡∏°‡∏µ‡∏Å‡∏•‡∏¥‡πà‡∏ô</option>
                        <option value="‡∏ô‡πâ‡∏≥‡∏°‡∏µ‡∏´‡∏ô‡∏≠‡∏ô‡πÑ‡∏£‡πÅ‡∏î‡∏á">‡∏ô‡πâ‡∏≥‡∏°‡∏µ‡∏´‡∏ô‡∏≠‡∏ô‡πÑ‡∏£‡πÅ‡∏î‡∏á</option>
                        <option value="‡∏ô‡πâ‡∏≥‡∏°‡∏µ‡∏™‡∏ô‡∏¥‡∏°">‡∏ô‡πâ‡∏≥‡∏°‡∏µ‡∏™‡∏ô‡∏¥‡∏°</option>
                        <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏áÂ§áÊ≥®)</option>
                    </select>
                </div>

                <!-- Other Problem Details -->
                <div id="otherProblemField" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label>
                    <input type="text" id="otherProblem" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>

                <!-- Contact Number -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ *</label>
                    <input type="tel" id="contactNumber" required class="w-full p-3 border border-gray-300 rounded-lg" placeholder="089-123-4567">
                </div>

                <!-- Location -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏û‡∏¥‡∏Å‡∏±‡∏î *</label>
                    <div class="flex space-x-2">
                        <input type="text" id="latitude" readonly class="flex-1 p-3 border border-gray-300 rounded-lg" placeholder="‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î">
                        <input type="text" id="longitude" readonly class="flex-1 p-3 border border-gray-300 rounded-lg" placeholder="‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î">
                    </div>
                    <button type="button" onclick="getLocation()" class="mt-2 text-sm text-blue-600 hover:text-blue-800">
                        üìç ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    </button>
                </div>

                <!-- Image Upload -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                    <input type="file" id="imageUpload" accept="image/*" class="w-full p-3 border border-gray-300 rounded-lg">
                    <div id="imagePreview" class="mt-2 hidden">
                        <img id="previewImg" class="w-full h-32 object-cover rounded-lg">
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="w-full btn-primary text-white py-3 px-4 rounded-lg font-semibold">
                    üì© ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤
                </button>
            </form>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyVonRxINr15fh83-Ti2Dpvmocs1jlGY_RT2m2NSFH6lig9YokomN_PchgAnZIy9roiBA/exec";

        // Initialize LIFF
        let userId = '';
        let userProfile = null;

        async function initializeLIFF() {
            try {
                await liff.init({ liffId: '2006915175-QL6m4dJK' });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // Get user profile
                userProfile = await liff.getProfile();
                userId = userProfile.userId;
                
                // Display user info
                document.getElementById('userInfo').innerHTML = `
                    <div class="flex items-center">
                        <img src="${userProfile.pictureUrl}" class="w-10 h-10 rounded-full mr-3">
                        <div>
                            <p class="font-semibold">${userProfile.displayName}</p>
                            <p class="text-xs text-gray-600">User ID: ${userId}</p>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('LIFF Initialization failed:', error);
                document.getElementById('userInfo').innerHTML = `
                    <p class="text-red-600">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</p>
                `;
            }
        }

        // Get current location
        function getLocation() {
            if (!navigator.geolocation) {
                alert("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î");
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    document.getElementById('latitude').value = position.coords.latitude;
                    document.getElementById('longitude').value = position.coords.longitude;
                },
                (error) => {
                    alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ: " + error.message);
                }
            );
        }

        // Handle image preview
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            }
        });

        // Show/hide other problem field
        document.getElementById('problemType').addEventListener('change', function() {
            const otherField = document.getElementById('otherProblemField');
            otherField.classList.toggle('hidden', this.value !== '‡∏≠‡∏∑‡πà‡∏ô‡πÜ');
        });

        // Handle form submission
        document.getElementById('complaintForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validate form
            const problemType = document.getElementById('problemType').value;
            const contactNumber = document.getElementById('contactNumber').value;
            const latitude = document.getElementById('latitude').value;
            const longitude = document.getElementById('longitude').value;

            if (!problemType || !contactNumber || !latitude || !longitude) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }

            // Show loading
            document.getElementById('loadingOverlay').classList.remove('hidden');

            try {
                // Prepare form data
                const formData = new FormData();
                formData.append('userId', userId);
                formData.append('userName', userProfile?.displayName || '');
                formData.append('problemType', problemType);
                
                const otherProblem = document.getElementById('otherProblem').value;
                if (otherProblem) {
                    formData.append('otherProblem', otherProblem);
                }
                
                formData.append('contactNumber', contactNumber);
                formData.append('latitude', latitude);
                formData.append('longitude', longitude);
                formData.append('timestamp', new Date().toLocaleString('th-TH'));

                // Add image if exists
                const imageFile = document.getElementById('imageUpload').files[0];
                if (imageFile) {
                    formData.append('image', imageFile);
                }

                // Send to Google Apps Script
                const response = await fetch(APP_SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // Send Flex Message to user
                    await sendFlexMessage(result);
                    alert('‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
                    document.getElementById('complaintForm').reset();
                    document.getElementById('imagePreview').classList.add('hidden');
                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                console.error('Submission error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
            } finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        });

        // Send Flex Message
        async function sendFlexMessage(result) {
            const flexMessage = {
                type: 'flex',
                altText: '‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
                contents: {
                    type: 'bubble',
                    header: {
                        type: 'box',
                        layout: 'vertical',
                        contents: [
                            {
                                type: 'text',
                                text: '‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
                                weight: 'bold',
                                size: 'xl',
                                color: '#1e77b3'
                            }
                        ],
                        backgroundColor: '#bedff0'
                    },
                    body: {
                        type: 'box',
                        layout: 'vertical',
                        contents: [
                            {
                                type: 'text',
                                text: `‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á: ${result.data.problemType}`,
                                margin: 'md'
                            },
                            {
                                type: 'text',
                                text: `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${result.data.timestamp}`,
                                margin: 'md'
                            },
                            {
                                type: 'text',
                                text: `‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: ${result.data.contactNumber}`,
                                margin: 'md'
                            },
                            {
                                type: 'text',
                                text: `‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${result.data.latitude}, ${result.data.longitude}`,
                                margin: 'md',
                                wrap: true
                            }
                        ]
                    },
                    footer: {
                        type: 'box',
                        layout: 'vertical',
                        contents: [
                            {
                                type: 'text',
                                text: '‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£',
                                size: 'sm',
                                color: '#666666',
                                align: 'center'
                            }
                        ]
                    }
                }
            };

            // Send via LIFF
            await liff.sendMessages([flexMessage]);
        }

        // Initialize the application
        window.onload = initializeLIFF;
    </script>
</body>
</html>
