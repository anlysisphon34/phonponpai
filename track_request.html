<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตรวจสอบคำร้อง</title>
    <script src="https://static.line-scdn.net/liff/edge/versions/2.1/sdk.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            text-align: center;
        }

        #loading {
            font-size: 18px;
            color: #666;
        }
    </style>
</head>

<body>
    <h1>ตรวจสอบคำร้อง</h1>
    <div id="loading">กำลังโหลดข้อมูล...</div>

    <script>
        async function initializeLiff() {
            try {
                await liff.init({ liffId: "YOUR_LIFF_ID" }); // ใส่ LIFF ID ของคุณ

                if (!liff.isLoggedIn()) {
                    liff.login(); // หากยังไม่ได้ล็อกอิน ให้ล็อกอินก่อน
                } else {
                    const profile = await liff.getProfile();
                    const userId = profile.userId;

                    // ดึงข้อมูลจาก Backend
                    const response = await fetch(`https://script.google.com/macros/s/AKfycbxBq2W1FGN-hd4X9fa16E_xdZFlrcaBXAR01j5AMGAmydYtkxI3GgJLMAHAlUtCfzP4/exec?userId=${userId}`);
                    const data = await response.json();

                    if (data.success) {
                        document.getElementById("loading").innerText = "กำลังส่งข้อความ...";

                        // ส่ง Flex Message ไปยังแชท LINE
                        const flexMessage = createFlexMessage(data);
                        await liff.sendMessages([flexMessage]);
                        document.getElementById("loading").innerText = "ส่งข้อความเรียบร้อยแล้ว!";
                    } else {
                        document.getElementById("loading").innerText = data.message;
                    }
                }
            } catch (error) {
                console.error("Error:", error);
                document.getElementById("loading").innerText = "เกิดข้อผิดพลาดในการโหลดข้อมูล";
            }
        }

        function createFlexMessage(data) {
            const { complaint, status, timestamps, durations } = data;

            return {
                type: "bubble",
                size: "mega",
                header: {
                    type: "box",
                    layout: "vertical",
                    contents: [
                        {
                            type: "box",
                            layout: "vertical",
                            contents: [
                                {
                                    type: "text",
                                    text: "ติดตามสถานะคำร้อง",
                                    color: "#ffffff",
                                    size: "xl",
                                    flex: 4,
                                    weight: "bold"
                                }
                            ]
                        },
                        {
                            type: "box",
                            layout: "vertical",
                            contents: [
                                {
                                    type: "text",
                                    text: "คุณ",
                                    color: "#ffffff66",
                                    size: "sm"
                                },
                                {
                                    type: "text",
                                    text: "ธวัชชัย  แซ่ก๊วย", // แก้ไขชื่อผู้ใช้ตามข้อมูลจริง
                                    color: "#ffffff",
                                    size: "xl",
                                    flex: 4,
                                    weight: "bold"
                                }
                            ]
                        }
                    ],
                    paddingAll: "20px",
                    spacing: "md",
                    height: "154px",
                    paddingTop: "22px",
                    background: {
                        type: "linearGradient",
                        angle: "45deg",
                        startColor: "#8428fd",
                        endColor: "#d4cafc"
                    }
                },
                body: {
                    type: "box",
                    layout: "vertical",
                    contents: [
                        {
                            type: "text",
                            text: `ระยะเวลาดำเนินการรวม: ${durations.total_duration}`,
                            color: "#b7b7b7",
                            size: "xs",
                            weight: "bold"
                        },
                        {
                            type: "box",
                            layout: "horizontal",
                            contents: [
                                {
                                    type: "text",
                                    text: `${timestamps.t1}`,
                                    size: "sm",
                                    gravity: "center",
                                    flex: 2,
                                    weight: "bold"
                                },
                                {
                                    type: "box",
                                    layout: "vertical",
                                    contents: [
                                        {
                                            type: "filler"
                                        },
                                        {
                                            type: "box",
                                            layout: "vertical",
                                            contents: [],
                                            cornerRadius: "30px",
                                            height: "12px",
                                            width: "12px",
                                            borderColor: "#EF454D",
                                            borderWidth: "2px"
                                        },
                                        {
                                            type: "filler"
                                        }
                                    ],
                                    flex: 0
                                },
                                {
                                    type: "text",
                                    text: "ยังไม่ดำเนินการ",
                                    gravity: "center",
                                    flex: 2,
                                    size: "sm",
                                    weight: "bold"
                                }
                            ],
                            spacing: "xxl",
                            cornerRadius: "30px",
                            margin: "xl"
                        },
                        {
                            type: "box",
                            layout: "horizontal",
                            contents: [
                                {
                                    type: "box",
                                    layout: "baseline",
                                    contents: [
                                        {
                                            type: "filler"
                                        }
                                    ],
                                    flex: 2
                                },
                                {
                                    type: "box",
                                    layout: "vertical",
                                    contents: [
                                        {
                                            type: "box",
                                            layout: "horizontal",
                                            contents: [
                                                {
                                                    type: "filler"
                                                },
                                                {
                                                    type: "box",
                                                    layout: "vertical",
                                                    contents: [],
                                                    width: "2px",
                                                    backgroundColor: "#B7B7B7"
                                                },
                                                {
                                                    type: "filler"
                                                }
                                            ],
                                            flex: 1
                                        }
                                    ],
                                    width: "12px"
                                },
                                {
                                    type: "text",
                                    text: `ระยะเวลา ${durations.div1_duration}`,
                                    gravity: "center",
                                    flex: 2,
                                    size: "xs",
                                    color: "#8c8c8c",
                                    wrap: true
                                }
                            ],
                            spacing: "lg",
                            height: "64px"
                        },
                        {
                            type: "box",
                            layout: "horizontal",
                            contents: [
                                {
                                    type: "text",
                                    text: `${timestamps.t2}`,
                                    size: "xs",
                                    gravity: "center",
                                    flex: 2
                                },
                                {
                                    type: "box",
                                    layout: "vertical",
                                    contents: [
                                        {
                                            type: "filler"
                                        },
                                        {
                                            type: "box",
                                            layout: "vertical",
                                            contents: [],
                                            cornerRadius: "30px",
                                            height: "12px",
                                            width: "12px",
                                            borderColor: "#EF454D",
                                            borderWidth: "2px"
                                        },
                                        {
                                            type: "filler"
                                        }
                                    ],
                                    flex: 0
                                },
                                {
                                    type: "text",
                                    text: "ดำเนินการติดต่อ",
                                    gravity: "center",
                                    flex: 2,
                                    size: "sm",
                                    color: "#8c8c8c"
                                }
                            ],
                            spacing: "xxl",
                            cornerRadius: "30px"
                        },
                        {
                            type: "box",
                            layout: "horizontal",
                            contents: [
                                {
                                    type: "box",
                                    layout: "baseline",
                                    contents: [
                                        {
                                            type: "filler"
                                        }
                                    ],
                                    flex: 2
                                },
                                {
                                    type: "box",
                                    layout: "vertical",
                                    contents: [
                                        {
                                            type: "box",
                                            layout: "horizontal",
                                            contents: [
                                                {
                                                    type: "filler"
                                                },
                                                {
                                                    type: "box",
                                                    layout: "vertical",
                                                    contents: [],
                                                    width: "2px",
                                                    backgroundColor: "#B7B7B7"
                                                },
                                                {
                                                    type: "filler"
                                                }
                                            ],
                                            flex: 1
                                        }
                                    ],
                                    width: "12px"
                                },
                                {
                                    type: "text",
                                    text: `ระยะเวลา ${durations.div2_duration}`,
                                    gravity: "center",
                                    flex: 2,
                                    size: "xs",
                                    color: "#8c8c8c",
                                    wrap: true
                                }
                            ],
                            spacing: "lg",
                            height: "64px"
                        },
                        {
                            type: "box",
                            layout: "horizontal",
                            contents: [
                                {
                                    type: "text",
                                    text: `${timestamps.t3}`,
                                    size: "xs",
                                    gravity: "center",
                                    flex: 2
                                },
                                {
                                    type: "box",
                                    layout: "vertical",
                                    contents: [
                                        {
                                            type: "filler"
                                        },
                                        {
                                            type: "box",
                                            layout: "vertical",
                                            contents: [],
                                            cornerRadius: "30px",
                                            height: "12px",
                                            width: "12px",
                                            borderColor: "#EF454D",
                                            borderWidth: "2px"
                                        },
                                        {
                                            type: "filler"
                                        }
                                    ],
                                    flex: 0
                                },
                                {
                                    type: "text",
                                    text: "กำลังดำเนินการ",
                                    gravity: "center",
                                    flex: 2,
                                    size: "sm",
                                    color: "#8c8c8c"
                                }
                            ],
                            spacing: "xxl",
                            cornerRadius: "30px"
                        },
                        {
                            type: "box",
                            layout: "horizontal",
                            contents: [
                                {
                                    type: "box",
                                    layout: "baseline",
                                    contents: [
                                        {
                                            type: "filler"
                                        }
                                    ],
                                    flex: 2
                                },
                                {
                                    type: "box",
                                    layout: "vertical",
                                    contents: [
                                        {
                                            type: "box",
                                            layout: "horizontal",
                                            contents: [
                                                {
                                                    type: "filler"
                                                },
                                                {
                                                    type: "box",
                                                    layout: "vertical",
                                                    contents: [],
                                                    width: "2px",
                                                    backgroundColor: "#B7B7B7"
                                                },
                                                {
                                                    type: "filler"
                                                }
                                            ],
                                            flex: 1
                                        }
                                    ],
                                    width: "12px"
                                },
                                {
                                    type: "text",
                                    text: `ระยะเวลา ${durations.div3_duration}`,
                                    gravity: "center",
                                    flex: 2,
                                    size: "xs",
                                    color: "#8c8c8c",
                                    wrap: true
                                }
                            ],
                            spacing: "lg",
                            height: "64px"
                        },
                        {
                            type: "box",
                            layout: "horizontal",
                            contents: [
                                {
                                    type: "text",
                                    text: `${timestamps.t4}`,
                                    size: "xs",
                                    gravity: "center",
                                    flex: 2
                                },
                                {
                                    type: "box",
                                    layout: "vertical",
                                    contents: [
                                        {
                                            type: "filler"
                                        },
                                        {
                                            type: "box",
                                            layout: "vertical",
                                            contents: [],
                                            cornerRadius: "30px",
                                            height: "12px",
                                            width: "12px",
                                            borderColor: "#EF454D",
                                            borderWidth: "2px"
                                        },
                                        {
                                            type: "filler"
                                        }
                                    ],
                                    flex: 0
                                },
                                {
                                    type: "text",
                                    text: "ดำเนินการเสร็จสิ้น",
                                    gravity: "center",
                                    flex: 2,
                                    size: "sm",
                                    color: "#8c8c8c"
                                }
                            ],
                            spacing: "xxl",
                            cornerRadius: "30px"
                        }
                    ]
                }
            };
        }

        initializeLiff();
    </script>
</body>

</html>
